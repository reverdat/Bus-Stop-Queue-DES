name: CI

on:
  push:
    branches: ["preassignment2/lib"]
  pull_request:
    branches: ["preassignment2/lib"]

permissions:
  actions: read
  contents: read

env:
  POETRY_VERSION: "2.2.1"
  PYTHON_VERSION: "3.12"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    
    runs-on: ${{ matrix.os }}

    defaults:
      run:
        working-directory: assignment2_preentrega/lib

    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6
      
      # Removed mlugg/setup-zig to avoid version conflicts with ziglang python package

      - uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6
        id: setup-python
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry via pipx
        run: pipx install poetry==${{ env.POETRY_VERSION }} --python '${{ steps.setup-python.outputs.python-path }}' --force

      - name: Configure Poetry
        run: poetry config virtualenvs.in-project true

      - name: Poetry git plugin
        run: poetry self add poetry-git-version-plugin

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: assignment2_preentrega/lib/.venv
          key: venv-${{ matrix.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('assignment2_preentrega/lib/poetry.lock') }}

      - name: Poetry Install
        env:
          # FIX: Set explicit cache dir to avoid CacheCheckFailed
          ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/zig-cache
          ZIG_LOCAL_CACHE_DIR: ${{ github.workspace }}/zig-cache
        run: poetry install -n -v

      - name: Poetry Build
        env:
          # FIX: Set explicit cache dir for build step too
          ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/zig-cache
          ZIG_LOCAL_CACHE_DIR: ${{ github.workspace }}/zig-cache
        run: poetry build -v

      - name: Ruff
        run: poetry run ruff check .

      - name: Ruff format
        run: poetry run ruff format --check .

      - name: Pytest
        run: poetry run pytest

      - name: Check stubs
        run: poetry run python -m ziglang build generate-stubs -Dcheck-stubs=true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: assignment2_preentrega/lib/dist/*